<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Flux VR</title>
  <link rel="stylesheet" type="text/css" href="/public/main.css">

  <!-- Unity autogenerated files -->
  <link rel="stylesheet" href="TemplateData/style.css">
  <script src="TemplateData/UnityProgress.js"></script>

  <!-- Flux SDK -->
  <script type="text/javascript" src="https://npmcdn.com/flux-sdk-browser@0.3.0/dist/flux-sdk-min.js"></script>

  <!-- Flux Data Selector -->
  <script type="text/javascript" src="flux-data-selector/flux-data-selector.js"></script>
</head>

<div class="under-viewport-controls flex space-between">
  <div class="flexbox-section">
    <div class="loading-message"></div>
    <div class="sharable-url display-on-load">
      <label for="url">Sharable URL: </label>
      <input id="url">
    </div>
  </div>
  <div class="display-on-load flexbox-section">
    <button class="switch-camera-button">
      <img class="cardboard" style="display:none;" src="/public/cardboard.png">
      <img class="screen" src="/public/screen.png">
    </button>
    <button class="fullscreen-not-unity">
      <img src="/public/fullscreen.png">
    </button>
    <button class="frisbee-button">
      <img src="/public/disc.png">
    </button>
  </div>
  <div class="display-on-load flexbox-section">
    <input class="geometry-size size-input" placeholder="Geometry size"></input>
  </div>
</div>

<div class="content display-on-load">
  <div class="flex vertical">
    <h1>Flux-Unity VR Viewer</h1>
    <ul class="loaded-keys-list">  </ul>
  </div>
</div>

<script>
  (function(context) {

    // Prevent the scary "WebGL not supported on mobile!" message in
    // Unity's autogenerated code. Nothing is supposed to depend on
    // window.userAgent or .vendor, but it could mess up analytics.
    // Use this at your own risk.
    navigator.__defineGetter__('userAgent', function(){ return ' '; });
    navigator.__defineGetter__('vendor', function(){ return ' '; });

  /**
   * Key list module
   */

    // Initialize data selector module (not the data selector UI).
    context.ds = new FluxDataSelector("fa4e6dc7-c032-4089-a5b7-4ae367c6d006",
      'https://flux-unity.herokuapp.com/');

    // Creates a hashmap, which will be used to remember all loaded keys.
    var keyList = {};

    var loadedKeysList = document.querySelector('.loaded-keys-list');

    document.querySelector('.loading-message').textContent =
      "Loading, this can take a while...";

    // This callback accepts new data keys as well as update information
    // for data keys that have already been loaded.
    // It is bound to the data selector's onValue callback.
    function LoadDataKey(datakey) {
      if (keyList[datakey.id]) {
        SendMessage("flux", "CreateGeometry",
          datakey.id + JSON.stringify(datakey.value));
      } else {
        keyList[datakey.id] = {
          id: datakey.id,
          label: datakey.label
        };
        SendMessage("flux", "CreateGeometry",
          datakey.id + JSON.stringify(datakey.value));
      }
      makeKeyList();
    };

    function makeKeyList(removeList) {
      if (!ds.selectedProjectId) return;
      var sharableUrl = "/?project=" +
        ds.selectedProjectId;
      while (loadedKeysList.firstChild) {
        loadedKeysList.removeChild(loadedKeysList.firstChild);
      }

      var AllkeyLiItems = document.querySelectorAll('[data-value]');
      for (var i = 0; i < AllkeyLiItems.length; i++) {
        AllkeyLiItems[i].classList.remove('selected');
      }

      if (!removeList) {
        var idx = 0;
        for (key in keyList) {
          var keyLi = document
            .querySelector('[data-value="' + keyList[key].id + '"]');
          if (keyLi !== null) keyLi.classList.add('selected');
          var li = document.createElement('li');
          li.textContent = "Key " + ++idx + ": " + keyList[key].label +
            ". Click to delete";
          li.addEventListener('click', (function(id) {
            return function(e) {
              SendMessage("flux", "DeleteGeometry", keyList[id].id);
              loadedKeysList.removeChild(e.target);
              delete keyList[id];
              makeKeyList();
            };
          })(keyList[key].id));
          loadedKeysList.appendChild(li);
          sharableUrl += "&key=" + keyList[key].id;
        }
        document.querySelector('#url').value =
          context.location.origin + '/view' + sharableUrl;
      }

      document.querySelector('.sharable-url').style.display =
        removeList ? 'none' : 'initial';
      history.pushState(null, null,
        removeList ? context.location.origin : sharableUrl);

      completeInitialLoading();
    };

    function ResetKeyList() {
      for (key in keyList) {
        SendMessage("flux", "DeleteGeometry", keyList[key].id);
      }
      keyList = {};
      makeKeyList(true);
    };

    // Show elements that aren't supposed to appear until everything is loaded.
    function completeInitialLoading() {
      // If this function has already run once, it won't run again.
      var alreadyRan = false;
      return (function() {
        if(alreadyRan) return;
        alreadyRan = true;

        ds.showExamples();
        document.querySelector('.loading-message').style.display = "none";
        var displayOnLoad = document.querySelectorAll('.display-on-load');
        Array.prototype.forEach.call(displayOnLoad, function(item) {
          item.style.opacity = 1;
        });
      })();
    };

    context.keyListModule = {
      LoadDataKey: LoadDataKey,
      ResetKeyList: ResetKeyList
    };

  /**
   * Loaded is called when the webgl viewport finishes loading.
   */

    function Loaded(arg) {

      // Search the url for a project and keys.
      var proj = (x = /[?&](project)=([\d\w]*)/.exec(context.location.search)) ?
        x[2] : null;
      if (proj && proj !== "undefined") {
        // This doesn't work yet.
        // $('.projects-selection-dropdown > div.menu')
        //   .append('<div class="item" data-value=' + proj +'>'+proj+'</div>');
        context.ds.selectProject(proj);
      }

      var noMatches = true, regex = /[?&](key)=([\d\w]*)/g, result;
      while((result = regex.exec(context.location.search)) !== null) {
          noMatches = false;
          context.ds.selectKey(result[2])
      }
      if (noMatches) completeInitialLoading();
    }
    context.Loaded = Loaded;

  /**
   * Event handlers for html elements
   */

    // Switches whether Use a stereoscopic camera with head tracking or
    // a monoscopic camera with mouse movement.
    document.querySelector('.switch-camera-button')
    .addEventListener('click', (function() {
      var desktopMode = false;
      function switchCameraHandler() {
        // If this has an accellerometer, initialize head tracking.
        if (context.DeviceMotionEvent !== undefined) {
          context.ondevicemotion = function(event) {
            ax = event.accelerationIncludingGravity.x
            ay = event.accelerationIncludingGravity.y
            az = event.accelerationIncludingGravity.z
            rotation = event.rotationRate;
            if (rotation != null && rotation.alpha != null) {
              SendMessage("player", "MoveMouseX", rotation.alpha/10);
              SendMessage("player", "MoveMouseY", rotation.beta/10);
              // Could do something with gamma eventually...
              // arGamma = Math.round(rotation.gamma);
            }
          }
        }

        SendMessage("player", "SwitchAllowMouseControls");
        SendMessage("player", "SwitchCameraMode");
        desktopMode = !desktopMode;
        document.querySelector('.cardboard').style.display =
          desktopMode ? "initial" : "none";
        document.querySelector('.screen').style.display =
          desktopMode ? "none" : "initial";
      };
      return switchCameraHandler;
    })());

    // Sets the size of loaded geometry in the Unity context.
    function sizeInputHandler(e) {
      if (typeof e.target.value !== "number") return;
      SendMessage("flux", "SetSize", parseFloat(e.target.value));

      var input = document.querySelector('.size-input');
      while (input.firstChild) {
        input.removeChild(input.firstChild);
      }
      var sizeChangedMessage = document.createElement('p');
      sizeChangedMessage.textContent = "Changed size to " + e.target.value;
      document.body.appendChild(sizeChangedMessage);
    }
    document.querySelector('.size-input')
    .addEventListener('change', sizeInputHandler);

    // Enter fullscreen mode
    document.querySelector('.fullscreen-not-unity')
    .addEventListener('click', function() {
      SetFullscreen(1);
    });

    // Allow frisbee throwing
    document.querySelector('.frisbee-button')
    .addEventListener('click', function() {
      SendMessage("player", "ToggleFrisbees");
    });

  })(window);
</script>

